# =============================================================================
# CORALOGIX OPENTELEMETRY COMPLIANCE HACKATHON
# =============================================================================
# PARTICIPANT CHALLENGE FILE
# Edit this file to complete challenges!
#
# After EVERY change, run:
#   make restart service=otel-collector
#
# Then wait 1-2 minutes for data to appear in Coralogix.
# =============================================================================

# Coralogix Exporter - sends data to Coralogix
exporters:
  coralogix:
    domain: "${CX_DOMAIN}"
    private_key: "${CX_API_KEY}"
    application_name: "otel-hackathon"
    subsystem_name: "${TEAM_NAME}"
    timeout: 30s

processors:
  # ===========================================================================
  # CHALLENGE 1: Find the PII (Discovery) - 20 points
  # ===========================================================================
  # This challenge requires NO code changes!
  # Use Coralogix to discover what PII is leaking.
  #
  # See HACKATHON-README.md for instructions.
  #
  # HINT: Look at traces from CheckoutService, PaymentService, EmailService
  # HINT: Search for attributes containing "card", "password", "email", "ssn"
  # ===========================================================================

  # ===========================================================================
  # CHALLENGE 2: Delete Sensitive Keys (Easy) - 30 points
  # ===========================================================================
  # GOAL: Remove database credentials and API secrets from traces entirely.
  #
  # STEPS:
  #   1. Uncomment the processor below (remove the # from each line)
  #   2. Scroll down to the "traces" pipeline in the service section
  #   3. Add "attributes/delete-secrets" to the processors list
  #   4. Run: make restart service=otel-collector
  #   5. Wait 1-2 minutes, then check Coralogix
  #
  # VERIFY IN CORALOGIX:
  #   - Go to Explore > Tracing
  #   - Filter by Subsystem = YOUR_TEAM_NAME
  #   - Find a CheckoutService span
  #   - The "db.password" attribute should be GONE (not masked, completely absent)
  #
  # BEFORE: db.password: "Pr0d_P@ssw0rd_2024!"
  # AFTER:  (attribute doesn't exist)
  # ===========================================================================
  # attributes/delete-secrets:
  #   actions:
  #     - key: db.password
  #       action: delete
  #     - key: db.connection_string
  #       action: delete
  #     - key: api.secret
  #       action: delete
  #     - key: session.token
  #       action: delete

  # ===========================================================================
  # CHALLENGE 3: PCI-DSS Credit Card Masking (Medium) - 40 points
  # ===========================================================================
  # GOAL: Redact credit card numbers to "****" for PCI-DSS compliance.
  #       The attribute stays, but the value is masked.
  #
  # STEPS:
  #   1. Uncomment the processor below
  #   2. Add "redaction/credit-cards" to the traces pipeline
  #   3. Run: make restart service=otel-collector
  #   4. Wait 1-2 minutes, then check Coralogix
  #
  # VERIFY IN CORALOGIX:
  #   - Go to Explore > Tracing
  #   - Filter by Subsystem = YOUR_TEAM_NAME
  #   - Find a PaymentService span
  #   - user.credit_card should show "****" instead of the actual number
  #
  # BEFORE: user.credit_card: "4532-8721-9012-3456"
  # AFTER:  user.credit_card: "****"
  #
  # NOTE: The regex patterns below match credit cards with or without dashes:
  #   - Visa: starts with 4
  #   - Mastercard: starts with 51-55
  #   - Any 16 digits with optional dashes/spaces
  # ===========================================================================
  # redaction/credit-cards:
  #   allow_all_keys: true
  #   blocked_values:
  #     # Visa cards (with or without separators)
  #     - "4[0-9]{3}[- ]?[0-9]{4}[- ]?[0-9]{4}[- ]?[0-9]{4}"
  #     # Mastercard (with or without separators)
  #     - "5[1-5][0-9]{2}[- ]?[0-9]{4}[- ]?[0-9]{4}[- ]?[0-9]{4}"
  #     # Generic 16-digit card pattern
  #     - "[0-9]{4}[- ]?[0-9]{4}[- ]?[0-9]{4}[- ]?[0-9]{4}"

  # ===========================================================================
  # CHALLENGE 4: Hash PII for Analytics (Medium) - 40 points (+10 bonus)
  # ===========================================================================
  # GOAL: Replace email addresses with SHA256 hashes for pseudonymized analytics.
  #       This allows tracking unique users without storing their actual email.
  #
  # STEPS:
  #   1. Uncomment the processor below
  #   2. Add "transform/hash-pii" to the traces pipeline
  #      IMPORTANT: Place it BEFORE any redaction processors!
  #   3. Run: make restart service=otel-collector
  #   4. Wait 1-2 minutes, then check Coralogix
  #
  # VERIFY IN CORALOGIX:
  #   - Go to Explore > Tracing
  #   - Filter by Subsystem = YOUR_TEAM_NAME
  #   - Find a CheckoutService span
  #   - You should see: user.email_hash: "a8f2d9e1..." (64-char hex)
  #   - You should NOT see: user.email (it's been deleted)
  #
  # BEFORE: user.email: "john.smith@example.com"
  # AFTER:  user.email_hash: "a8f2d9e1c4b73f5a..." (original email is gone)
  #
  # WHY: GDPR allows pseudonymized data for analytics. The hash lets you
  #      count unique users without storing identifiable information.
  #
  # BONUS (+10 points): Also hash user.ssn and customer.email!
  # ===========================================================================
  # transform/hash-pii:
  #   error_mode: ignore
  #   trace_statements:
  #     - context: span
  #       statements:
  #         # Hash the email, store in new attribute
  #         - set(attributes["user.email_hash"], SHA256(attributes["user.email"])) where attributes["user.email"] != nil
  #         # Delete the original email
  #         - delete_key(attributes, "user.email")
  #         #
  #         # BONUS: Uncomment these to also hash SSN (+5 points)
  #         # - set(attributes["user.ssn_hash"], SHA256(attributes["user.ssn"])) where attributes["user.ssn"] != nil
  #         # - delete_key(attributes, "user.ssn")
  #         #
  #         # BONUS: Uncomment these to also hash customer.email (+5 points)
  #         # - set(attributes["customer.email_hash"], SHA256(attributes["customer.email"])) where attributes["customer.email"] != nil
  #         # - delete_key(attributes, "customer.email")

  # ===========================================================================
  # CHALLENGE 5: Zero-Trust Allowlist (Hard) - 50 points
  # ===========================================================================
  #
  # ⚠️  WARNING: THIS IS DESTRUCTIVE! ⚠️
  #
  # This processor REMOVES all attributes except those explicitly allowed.
  # You will lose most debugging information. Only enable this if you
  # understand the implications.
  #
  # GOAL: Implement fail-closed security. Only explicitly allowed attributes
  #       pass through. Everything else is dropped.
  #
  # STEPS:
  #   1. Uncomment the processor below
  #   2. Add "redaction/allowlist" to the traces pipeline
  #   3. Run: make restart service=otel-collector
  #   4. Wait 1-2 minutes, then check Coralogix
  #
  # VERIFY IN CORALOGIX:
  #   - Go to Explore > Tracing
  #   - Filter by Subsystem = YOUR_TEAM_NAME
  #   - Spans should only have the allowed keys listed below
  #   - All other attributes (including any PII) are GONE
  #
  # BEFORE: 20+ attributes per span
  # AFTER:  Only 5-10 explicitly allowed attributes
  #
  # REAL WORLD: This is the most secure approach but breaks debugging.
  #             Use this when compliance trumps observability.
  # ===========================================================================
  # redaction/allowlist:
  #   allow_all_keys: false
  #   allowed_keys:
  #     - http.method
  #     - http.status_code
  #     - http.route
  #     - http.url
  #     - rpc.service
  #     - rpc.method
  #     - service.name
  #     - span.kind
  #     - status.code
  #     - otel.status_code
  #   summary: debug

  # ===========================================================================
  # CHALLENGE 6: Intelligent Tail Sampling (Hard) - 50 points
  # ===========================================================================
  # GOAL: Keep 100% of error traces, sample only 10% of successful traces.
  #       This reduces costs while ensuring you never miss errors.
  #
  # STEPS:
  #   1. Uncomment the processor below
  #   2. Add "tail_sampling/intelligent" to the traces pipeline
  #      IMPORTANT: Must be BEFORE "batch" processor!
  #   3. Run: make restart service=otel-collector
  #   4. Wait 1-2 minutes, then check Coralogix
  #
  # VERIFY IN CORALOGIX:
  #   - Generate some traffic (browse the store)
  #   - Try to trigger an error if possible
  #   - Error traces should ALL be present
  #   - Successful traces should be reduced (only ~10% kept)
  #
  # POLICIES EXPLAINED:
  #   - keep-all-errors: Any trace with ERROR status is kept (100%)
  #   - sample-rest: Everything else is sampled at 10%
  #
  # WHY: In financial services, errors must never be dropped (compliance).
  #      But you don't need 100% of successful "GET /health" requests.
  #
  # PIPELINE ORDER: This processor MUST come before "batch"!
  # ===========================================================================
  # tail_sampling/intelligent:
  #   decision_wait: 10s
  #   num_traces: 50000
  #   policies:
  #     - name: keep-all-errors
  #       type: status_code
  #       status_code:
  #         status_codes:
  #           - ERROR
  #     - name: keep-slow-traces
  #       type: latency
  #       latency:
  #         threshold_ms: 2000
  #     - name: sample-rest
  #       type: probabilistic
  #       probabilistic:
  #         sampling_percentage: 10

connectors:
  spanmetrics:
    dimensions:
      - name: http.method
      - name: http.status_code
      - name: http.route
      - name: service.name
    histogram:
      explicit:
        buckets: [10ms, 50ms, 100ms, 250ms, 500ms, 1s, 2s, 5s, 10s]
    exemplars:
      enabled: true

# =============================================================================
# SERVICE PIPELINES
# =============================================================================
# To complete challenges, you need to ADD your processors to the pipelines below.
#
# Example: To enable Challenge 2, change the traces pipeline from:
#   processors: [resourcedetection, memory_limiter, transform, transform/inject-pii, batch]
# To:
#   processors: [resourcedetection, memory_limiter, transform, transform/inject-pii, attributes/delete-secrets, batch]
#
# PROCESSOR ORDER MATTERS! Follow this order:
#   1. resourcedetection (base)
#   2. memory_limiter (base)
#   3. transform (base)
#   4. transform/inject-pii (base - creates the problem)
#   5. attributes/delete-secrets (Challenge 2)
#   6. transform/hash-pii (Challenge 4 - BEFORE redaction!)
#   7. redaction/credit-cards (Challenge 3)
#   8. redaction/allowlist (Challenge 5)
#   9. tail_sampling/intelligent (Challenge 6 - BEFORE batch!)
#   10. batch (base - ALWAYS last)
# =============================================================================
service:
  pipelines:
    traces:
      receivers: [otlp]
      # ADD YOUR PROCESSORS HERE (before "batch")
      processors:
        [
          resourcedetection,
          memory_limiter,
          transform,
          transform/inject-pii,
          batch,
        ]
      exporters: [coralogix, otlp, debug, spanmetrics]

    metrics:
      receivers:
        [
          docker_stats,
          httpcheck/frontend-proxy,
          hostmetrics,
          nginx,
          otlp,
          postgresql,
          redis,
          spanmetrics,
        ]
      processors: [resourcedetection, memory_limiter, batch]
      exporters: [coralogix, otlphttp/prometheus, debug]

    logs:
      receivers: [otlp]
      processors: [resourcedetection, memory_limiter, batch]
      exporters: [coralogix, opensearch, debug]
