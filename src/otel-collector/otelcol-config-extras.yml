# extra settings to be merged into OpenTelemetry Collector configuration
# do not delete this file

# =============================================================================
# JP MORGAN x CORALOGIX OPENTELEMETRY HACKATHON
# =============================================================================
# YOUR CHALLENGE: Fix the PII leakage! Check Jaeger to see the problem.
# Edit this file, then: docker compose restart otelcol
# =============================================================================

exporters:
  coralogix:
    domain: "${CX_DOMAIN}"
    private_key: "${CX_API_KEY}"
    application_name: "otel-hackathon"
    subsystem_name: "${TEAM_NAME}"
    timeout: 30s

processors:
  # ===========================================================================
  # CHALLENGE 1: Business Context (Easy - 5 min)
  # Add cost allocation attributes
  # ===========================================================================
  # resource/cost-allocation:
  #   attributes:
  #     - key: trading.desk
  #       value: "equity-derivatives"
  #       action: upsert
  #     - key: business.unit
  #       value: "investment-banking"
  #       action: upsert

  # ===========================================================================
  # CHALLENGE 2: Delete Secrets (Easy - 5 min)
  # Remove dangerous keys like db.password, api.secret
  # ===========================================================================
  # attributes/delete-secrets:
  #   actions:
  #     - key: db.password
  #       action: delete
  #     - key: db.connection_string
  #       action: delete
  #     - key: api.secret
  #       action: delete
  #     - key: session.token
  #       action: delete

  # ===========================================================================
  # CHALLENGE 3: Credit Card Masking (Medium - 10 min)
  # Mask credit card patterns for PCI-DSS compliance
  # ===========================================================================
  # redaction/credit-cards:
  #   allow_all_keys: true
  #   blocked_values:
  #     - "4[0-9]{12}(?:[0-9]{3})?"
  #     - "5[1-5][0-9]{14}"
  #     - "[0-9]{4}[-\\s]?[0-9]{4}[-\\s]?[0-9]{4}[-\\s]?[0-9]{4}"

  # ===========================================================================
  # CHALLENGE 4: Hash PII (Medium - 10 min)
  # Hash emails/SSN for analytics without exposing PII
  # ===========================================================================
  # transform/hash-pii:
  #   error_mode: ignore
  #   trace_statements:
  #     - context: span
  #       statements:
  #         - set(attributes["user.email_hash"], SHA256(attributes["user.email"])) where attributes["user.email"] != nil
  #         - delete_key(attributes, "user.email")

  # ===========================================================================
  # CHALLENGE 5: Zero-Trust Allowlist (Hard - 15 min)
  # Only allow known-safe attributes
  # ===========================================================================
  # redaction/allowlist:
  #   allow_all_keys: false
  #   allowed_keys:
  #     - http.method
  #     - http.status_code
  #     - rpc.service
  #     - service.name
  #   summary: debug

  # ===========================================================================
  # CHALLENGE 6: Tail Sampling (Hard - 20 min)
  # Keep errors, sample routine traffic
  # ===========================================================================
  # tail_sampling/intelligent:
  #   decision_wait: 10s
  #   num_traces: 50000
  #   policies:
  #     - name: keep-errors
  #       type: status_code
  #       status_code:
  #         status_codes: [ERROR]
  #     - name: sample-rest
  #       type: probabilistic
  #       probabilistic:
  #         sampling_percentage: 10

connectors:
  spanmetrics:
    dimensions:
      - name: http.method
      - name: http.status_code
      - name: service.name

# =============================================================================
# PIPELINE - The PII injection runs in base config, your fixes run here
# =============================================================================
service:
  pipelines:
    traces:
      receivers: [otlp]
      processors:
        - resourcedetection
        - memory_limiter
        - transform
        - transform/inject-pii
        # --- ADD YOUR PROCESSORS HERE ---
        # - resource/cost-allocation
        # - attributes/delete-secrets
        # - transform/hash-pii
        # - redaction/credit-cards
        # - redaction/allowlist
        # - tail_sampling/intelligent
        # --------------------------------
        - batch
      exporters: [coralogix, otlp, spanmetrics, debug]
    metrics:
      receivers: [docker_stats, httpcheck/frontend-proxy, hostmetrics, nginx, otlp, postgresql, redis, spanmetrics]
      processors: [resourcedetection, memory_limiter, batch]
      exporters: [coralogix, otlphttp/prometheus, debug]
    logs:
      receivers: [otlp]
      processors: [resourcedetection, memory_limiter, batch]
      exporters: [coralogix, opensearch, debug]
