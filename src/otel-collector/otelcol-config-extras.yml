# =============================================================================
# üèÜ JP MORGAN x CORALOGIX OPENTELEMETRY HACKATHON
# =============================================================================
# PARTICIPANT CHALLENGE FILE - Edit this file to complete challenges!
# =============================================================================

# Coralogix Exporter - sends data to Coralogix
exporters:
  coralogix:
    domain: "${CX_DOMAIN}"
    private_key: "${CX_API_KEY}"
    application_name: "otel-hackathon"
    subsystem_name: "${TEAM_NAME}"
    timeout: 30s

processors:
  # ===========================================================================
  # CHALLENGE 1: Business Context Attribution (Easy)
  # ===========================================================================
  # Uncomment and add more attributes for your team
  # resource/cost-allocation:
  #   attributes:
  #     - key: trading.desk
  #       value: "equity-derivatives"
  #       action: upsert

  # ===========================================================================
  # CHALLENGE 2: Delete Sensitive Keys (Easy)
  # ===========================================================================
  # attributes/delete-secrets:
  #   actions:
  #     - key: db.password
  #       action: delete
  #     - key: db.connection_string
  #       action: delete
  #     - key: api.secret
  #       action: delete
  #     - key: session.token
  #       action: delete

  # ===========================================================================
  # CHALLENGE 3: PCI-DSS Credit Card Masking (Medium)
  # ===========================================================================
  # redaction/credit-cards:
  #   allow_all_keys: true
  #   blocked_values:
  #     - "4[0-9]{12}(?:[0-9]{3})?"
  #     - "5[1-5][0-9]{14}"
  #     - "[0-9]{4}[-\\s]?[0-9]{4}[-\\s]?[0-9]{4}[-\\s]?[0-9]{4}"

  # ===========================================================================
  # CHALLENGE 4: Hash PII for Analytics (Medium)
  # ===========================================================================
  # transform/hash-pii:
  #   error_mode: ignore
  #   trace_statements:
  #     - context: span
  #       statements:
  #         - set(attributes["user.email_hash"], SHA256(attributes["user.email"])) where attributes["user.email"] != nil
  #         - delete_key(attributes, "user.email")

  # ===========================================================================
  # CHALLENGE 5: Zero-Trust Allowlist (Hard)
  # ===========================================================================
  # redaction/allowlist:
  #   allow_all_keys: false
  #   allowed_keys:
  #     - http.method
  #     - http.status_code
  #     - rpc.service
  #     - rpc.method
  #     - service.name
  #   summary: debug

  # ===========================================================================
  # CHALLENGE 6: Intelligent Tail Sampling (Hard)
  # ===========================================================================
  # tail_sampling/intelligent:
  #   decision_wait: 10s
  #   num_traces: 50000
  #   policies:
  #     - name: keep-all-errors
  #       type: status_code
  #       status_code:
  #         status_codes:
  #           - ERROR
  #     - name: sample-rest
  #       type: probabilistic
  #       probabilistic:
  #         sampling_percentage: 10

connectors:
  spanmetrics:
    dimensions:
      - name: http.method
      - name: http.status_code
      - name: http.route
      - name: service.name
    histogram:
      explicit:
        buckets: [10ms, 50ms, 100ms, 250ms, 500ms, 1s, 2s, 5s, 10s]
    exemplars:
      enabled: true

# =============================================================================
# SERVICE PIPELINES - Coralogix exporter is ENABLED
# =============================================================================
service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [resourcedetection, memory_limiter, transform, transform/inject-pii, batch]
      exporters: [coralogix, otlp, debug, spanmetrics]
    
    metrics:
      receivers: [docker_stats, httpcheck/frontend-proxy, hostmetrics, nginx, otlp, postgresql, redis, spanmetrics]
      processors: [resourcedetection, memory_limiter, batch]
      exporters: [coralogix, otlphttp/prometheus, debug]
    
    logs:
      receivers: [otlp]
      processors: [resourcedetection, memory_limiter, batch]
      exporters: [coralogix, opensearch, debug]
